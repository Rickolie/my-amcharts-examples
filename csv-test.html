<!DOCTYPE html>
<html>
<head>
  <script src="https://cdn.amcharts.com/lib/5/index.js"></script>
  <script src="https://cdn.amcharts.com/lib/5/xy.js"></script>
  <script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <meta charset="UTF-8" />
  <title>CSV Example</title>
  <style>
    #chartdiv {
      width: 100%;
      height: 500px;
    }
  </style>
</head>
<body>
  <div id="chartdiv"></div>

  <script>
  am5.ready(function() {
    var root = am5.Root.new("chartdiv");
    root.setThemes([ am5themes_Animated.new(root) ]);

    var chart = root.container.children.push(am5xy.XYChart.new(root, {
      panX: true,
      panY: true,
      wheelX: "panX",
      wheelY: "zoomX"
    }));

    var xAxis = chart.xAxes.push(am5xy.DateAxis.new(root, {
      maxDeviation: 0.2,
      groupData: false,
      baseInterval: { timeUnit: "millisecond", count: 1 },
      renderer: am5xy.AxisRendererX.new(root, {}),
      tooltip: am5.Tooltip.new(root, {})
    }));

    var yAxis = chart.yAxes.push(am5xy.ValueAxis.new(root, {
      renderer: am5xy.AxisRendererY.new(root, {})
    }));

    var series = chart.series.push(am5xy.LineSeries.new(root, {
      name: "Cabinet Temp",
      xAxis: xAxis,
      yAxis: yAxis,
      valueYField: "CABINET_TEMPERATURE",
      valueXField: "datetime",
      tooltip: am5.Tooltip.new(root, { labelText: "{valueY}" })
    }));

    // Load CSV
    Papa.parse("csv/dataold.csv", {
      download: true,
      header: true,
      dynamicTyping: true,
      complete: function(results) {
        let parsed = results.data
          .filter(row => row.datetime) // remove empty rows
          .map(row => {
            // Convert datetime with microseconds to milliseconds only
            // e.g. 2025-08-03T00:00:00.000000 -> 2025-08-03T00:00:00.000
            let dt = row.datetime.replace(/^(\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2})\.(\d{3})\d{3}$/, "$1.$2");

            return {
              ...row,
              datetime: new Date(dt).getTime()
            };
          });

        if (parsed.length === 0) {
          console.error("No valid rows found in CSV (datetime parsing failed). Check CSV path/format.");
          return;
        }

        series.data.setAll(parsed);
      }
    });

    series.appear(1000);
    chart.appear(1000, 100);
  });
  </script>
</body>
</html>
