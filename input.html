<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Signal Viewer</title>
<script src="https://cdn.amcharts.com/lib/5/index.js"></script>
<script src="https://cdn.amcharts.com/lib/5/xy.js"></script>
<script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  input[type="file"] { display: block; margin-bottom: 10px; }
  #signalListContainer { margin: 15px 0; }
  label.signal { display: block; margin: 3px 0; }
  #chartdiv { width: 100%; height: 500px; margin-top: 20px; }
</style>
</head>
<body>

<h1>Signal Data Graph</h1>

<label>DataLog:</label>
<input type="file" id="dataLog">

<label>SignalList:</label>
<input type="file" id="signalList">

<label>EventLog:</label>
<input type="file" id="eventLog">

<label>SwitchLog:</label>
<input type="file" id="switchLog">

<label>AlarmLog:</label>
<input type="file" id="alarmLog">

<div id="signalListContainer"></div>

<div id="chartdiv"></div>

<script>
let dataLogData = [];
let signalNames = [];
let chart, xAxis, yAxis;
let activeSeries = {};

function readFile(file, callback) {
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => callback(e.target.result);
  reader.readAsText(file);
}

function parseCSV(text) {
  return text.trim().split("\n").map(line => line.split(","));
}

function initChart() {
  am5.ready(function() {
    let root = am5.Root.new("chartdiv");
    root.setThemes([am5themes_Animated.new(root)]);
    chart = root.container.children.push(am5xy.XYChart.new(root, {
      panX: true, panY: true, wheelX: "panX", wheelY: "zoomX"
    }));

    xAxis = chart.xAxes.push(am5xy.CategoryAxis.new(root, {
      categoryField: "time",
      renderer: am5xy.AxisRendererX.new(root, { minGridDistance: 50 })
    }));

    yAxis = chart.yAxes.push(am5xy.ValueAxis.new(root, {
      renderer: am5xy.AxisRendererY.new(root, {})
    }));
  });
}

function updateSignalCheckboxes() {
  const container = document.getElementById("signalListContainer");
  container.innerHTML = "<h3>Select Signals:</h3>";
  signalNames.forEach((name, index) => {
    if (index === 0) return; // index 0 is timestamp or time
    const label = document.createElement("label");
    label.className = "signal";
    const cb = document.createElement("input");
    cb.type = "checkbox";
    cb.dataset.index = index;
    cb.addEventListener("change", () => {
      if (cb.checked) {
        addSeries(index);
      } else {
        removeSeries(index);
      }
    });
    label.appendChild(cb);
    label.appendChild(document.createTextNode(" " + name));
    container.appendChild(label);
  });
}

function addSeries(colIndex) {
  if (activeSeries[colIndex]) return;

  let series = chart.series.push(am5xy.LineSeries.new(chart.root, {
    name: signalNames[colIndex],
    xAxis: xAxis,
    yAxis: yAxis,
    valueYField: "col" + colIndex,
    categoryXField: "time"
  }));

  let dataset = dataLogData.slice(1).map(row => {
    return { time: row[0], ["col" + colIndex]: parseFloat(row[colIndex]) };
  });

  series.data.setAll(dataset);
  activeSeries[colIndex] = series;
}

function removeSeries(colIndex) {
  if (!activeSeries[colIndex]) return;
  chart.series.removeValue(activeSeries[colIndex]);
  delete activeSeries[colIndex];
}

document.getElementById("dataLog").addEventListener("change", e => {
  readFile(e.target.files[0], text => {
    dataLogData = parseCSV(text);
    // If signalNames already loaded, update checkboxes
    if (signalNames.length > 0) updateSignalCheckboxes();
  });
});

document.getElementById("signalList").addEventListener("change", e => {
  readFile(e.target.files[0], text => {
    let parsed = parseCSV(text);
    // Assuming first column = signal ID, second = name
    // We'll just map them in order for simplicity
    signalNames = parsed.map(row => row[1] || row[0]);
    if (dataLogData.length > 0) updateSignalCheckboxes();
  });
});

// Initialize chart on page load
initChart();
</script>

</body>
</html>
